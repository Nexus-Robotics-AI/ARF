# 🔥 ARF 模块开发参考文档：舰队管理 (Fleet Mgt.)

> 🎯 **角色定位:** ARF的"总指挥中心" - 对全球范围内的机器人进行大规模部署、监控和运维。
>
> 📦 **模块代号:** `arf-cloud-fleet`
>
> ⚡ **所属:** ARF 云端平面 (Cloud Plane)

---

## 📋 1. 核心职责与设计理念

### 🎯 核心使命 (Core Mission)

作为ARF生态的“群体智能与优化中心”，舰队管理模块的核心使命是**为部署在全球范围内的、数以万计的机器人（边缘节点）提供一个统一的、可视化的、自动化的管理与运维平台**。它的进化目标是超越传统的设备管理（OTA、监控），成为一个能够**执行大规模A/B测试**、实现**数据驱动决策**并赋能**群体知识共享**的智能协调中枢。

主要应用场景包括：

- **🚀 软件部署与更新 (OTA):** 将`插件市场`中的软件包（驱动、算法、应用套件）安全、可靠地推送到指定的机器人或机器人组。
- **🩺 远程监控与诊断:** 实时监控整个舰队的健康状况（CPU、电量、网络、任务状态），并在出现异常时发出告警。
- **⚙️ 配置管理:** 对机器人集群进行分组，并远程批量更新其配置参数。
- **📊 日志与指标聚合:** 统一收集所有机器人的日志和性能指标，用于故障排查和数据分析。
- **🧠 边缘智能策略配置:** 为不同机器人组，远程下发和管理精细化的边缘策略，如`ACR`的资源自适应规则和`DMS`的智能上传规则。
- **🔬 舰队级A/B测试:** 以可控、可度量的方式，在真实环境中对不同版本的算法或策略进行分组对比实验。
- **🧠 群体知识共享:** 将单个机器人的宝贵经验（如成功解决某个难题的策略）泛化并分发给整个舰队。



### 🏗️ 核心架构：基于云原生边缘计算 + 数据驱动闭环 (Cloud-Native Edge + Data-Driven Loop)

我们采用业界主流的云原生边缘计算架构，将Kubernetes的能力从云端延伸到边缘端。

- **云端控制器 (Cloud Controller):** 运行在云端`ARF Cloud Plane`的核心服务。它作为管理平面的大脑，负责接收用户的管理指令，并维护所有边缘节点的期望状态（Desired State）。V1.1版本中，其职责扩展，包含一个“**边缘策略管理器**”，负责存储和下发如`ACR`资源调度、`DMS`智能同步等高级配置。
- **边缘代理 (Edge Agent):** 运行在每一个机器人（边缘节点）上的轻量级代理程序。它的职责是定期与云端控制器通信，获取自己最新的“期望状态”，然后与本地的“实际状态”进行比较，并执行必要的动作（如拉取新镜像、启动/停止容器）来使两者保持一致。
- **实验与分析引擎 (Experimentation & Analytics Engine):** 这是一个新的核心组件，与`数据中心`和`评测模块`紧密集成。它负责设计、执行和分析舰队级的A/B测试，并将实验结果转化为可执行的部署决策（如“全量推广”或“回滚”）。



### ⚖️ 设计原则 (Design Principles)

- **🚀 可伸缩性 (Scalability):** 架构必须能够支持从管理10台机器人到10万台机器人的平滑扩展。
- **🛡️ 可靠性:** 即使在机器人网络连接不稳定或断开的情况下，边缘代理也必须能保证机器人核心功能的持续运行，并在网络恢复后自动同步状态。
- **🔒 安全性:** 所有云-边通信都必须是双向认证和端到端加密的。软件部署必须经过签名验证。
- **👁️ 可观测性 (Observability):** 必须提供丰富的监控指标和日志查询能力，让运维人员对整个舰队的状态了如指掌。
- **📈 数据驱动 (Data-Driven):** 所有的软件版本迭代和策略变更，都应基于在真实环境中运行的A/B测试数据进行决策。

---

## 📝 2. 核心需求 (Core Requirements)

| ID     | 需求描述                                   | 验收标准                                                     | 优先级         |
| :----- | :----------------------------------------- | :----------------------------------------------------------- | :------------- |
| **F1** | **安全OTA更新 (Secure OTA)**               | 必须支持对单个或一组机器人进行远程软件（容器镜像）更新，更新过程支持灰度发布和一键回滚。 | **最高**       |
| **F2** | **实时状态监控 (Real-time Monitoring)**    | 必须提供一个Web仪表盘，能够实时展示整个舰队的地理分布、在线状态、关键健康指标（CPU/内存/电量）。 | **最高**       |
| **F3** | **设备分组与配置管理**                     | 必须支持将机器人按标签（如“北京-A栋”、“家庭-测试版”）进行分组，并能对整个分组下发统一的配置更新。 | **高**         |
| **F4** | **远程日志与诊断**                         | 必须支持远程查看任意一台机器人的实时日志，并能触发其运行预设的诊断程序。 | **高**         |
| **F5** | **弱网络鲁棒性 (Weak Network Robustness)** | 边缘代理在网络断开时，必须能自主运行。在网络恢复后，能自动重新连接并同步状态，期间不丢失关键数据。 | **最高**       |
| **F6** | **舰队级A/B测试框架**                      | **[V1.1+ 新增]** 必须提供API和UI，允许用户定义实验组和对照组，部署不同版本的插件，并指定核心评测指标（KPI）。 | **高 (V1.1+)** |
| **F7** | **群体知识共享机制**                       | **[V1.1+ 新增]** 必须建立一个流程，用于接收、泛化和重新分发由单个机器人学习到的新知识或技能。 | **中 (V1.1+)** |
| **F8** | **能力感知部署**                           | **[V1.1+ 新增]** 在部署插件前，必须检查目标设备是否具备插件所需的特殊能力（如`PREEMPT_RT`内核）。 | **高 (V1.1+)** |

---

## ⚙️ 3. 关键功能与子模块架构

### 🧠 3.1 云端控制器 (Cloud Controller)

**舰队大脑角色**：这是一个用`Go`实现的、运行在云端Kubernetes上的核心服务。

- **API端点:** 对外提供一个gRPC服务（`fleet.proto`）和一个RESTful Web API，供`arf-cli`和Web前端调用。
- **设备注册与心跳:** 管理所有边缘节点的注册、认证和心跳信息。
- **期望状态存储:** 使用一个数据库（如etcd或PostgreSQL）来存储每个设备/设备组的期望配置（如应部署的插件列表及其版本）。
- **指令下发器:** 当检测到期望状态与报告的实际状态不一致时，生成相应的指令（如`DeployPlugin`）并安全地发送给边缘代理。V1.1中，指令下发前增加“**前置条件检查 (Prerequisite Check)**”步骤。它会从`插件市场`获取插件所需的能力标签（如`capability:rts_hard_realtime`），并与目标设备的设备画像进行比对，只有满足条件才允许部署。

### 🤖 3.2 边缘代理 (Edge Agent)

**驻场工程师角色**：这是一个运行在每个机器人上的轻量级程序。

- **核心框架:** 基于一个成熟的云原生边缘计算框架，如**KubeEdge**或**OpenYurt**。这将为我们处理掉大量复杂的云-边通信和状态同步问题。
- **状态同步器:** 定期向云端控制器上报自己的实际状态（当前运行的容器列表、硬件状态等）。
- **指令执行器:** 监听来自云端的指令，并调用本地的`ACR运行时`或`HAL管理器`来执行这些指令（如启动/停止容器、更新配置）。
- **离线缓存:** 在网络断开时，将需要上报的日志和指标缓存在本地，待网络恢复后重新发送。

### V1.1 新增高级功能子模块

### 🔬 3.3 实验与分析引擎 (Experimentation & Analytics Engine)

**数据科学家角色**：这是一个新的后端服务，作为`云端控制器`的智能扩展。

- **职责:**
  1. 提供API用于定义A/B测试实验（如`StartExperiment`）。
  2. 根据实验定义，自动创建设备分组，并调用`DeployPlugin`接口将不同版本的插件部署下去。
  3. 持续从`数据中心`拉取和分析实验组与对照组上传的性能指标数据。
  4. 通过统计学方法判断实验结果的显著性，并生成可视化报告，为“全量”或“回滚”提供决策支持。

### 📚 3.4 群体知识管理器 (Collective Knowledge Manager)

**知识萃取与传播者角色**：这是一个与`训练模块`和`插件市场`联动的自动化工作流。

- **职责:**
  1. 监控`数据中心`中被标记为“宝贵经验”的特殊数据集（由边缘端`DMS`在特定场景下触发记录）。
  2. 自动触发`训练模块`中的一个特殊流水线，将这份“个例经验”泛化为一个可复用的策略模块或配置更新。
  3. 将新生成的“知识插件”发布到`插件市场`。
  4. 通知管理员，这个新的知识插件已准备好，可以通过`舰队管理`模块分发给其他有需要的机器人。

---

## 🔗 4. 接口设计与数据流

舰队管理是连接云端“意图”和边缘端“现实”的桥梁。

### 📥 输入数据流

| **数据源**               | **数据类型**                 | **优先级** | **延迟要求**             | **示例场景**                                   |
| :----------------------- | :--------------------------- | :--------- | :----------------------- | :--------------------------------------------- |
| **开发者/运维(CLI/Web)** | `DeployPluginRequest` (gRPC) | `NORMAL`   | `< 5s`                   | 运维人员点击“发布”按钮，将新版算法推送到测试组 |
| **边缘代理**             | `DeviceStatus` (gRPC)        | `NORMAL`   | `< 60s`                  | 机器人每分钟上报一次心跳和健康状况             |
| **插件市场**             | `PluginIdentifier`           | `NORMAL`   | N/A                      | 云端控制器从插件市场获取要部署的软件信息       |
| **数据中心**             | 机器人性能指标数据           | `NORMAL`   | N/A (批处理)             | 实验引擎分析A/B测试结果                        |
| **训练模块**             | `StartTrainingJobRequest`    | 自动触发   | 触发“群体知识”的泛化训练 |                                                |

### 📤 输出数据流

| **目标模块** | **数据类型**              | **保证**     | **性能指标**                |
| :----------- | :------------------------ | :----------- | :-------------------------- |
| **边缘代理** | 部署/配置指令             | 可靠消息传递 | 指令下发延迟 < 10s          |
| **Web UI**   | 聚合后的舰队状态数据      | 实时更新     | 仪表盘数据刷新率 > 0.1Hz    |
| **告警系统** | `Alert`                   | 可靠通知     | 机器人离线后5分钟内发出告警 |
| **训练模块** | `StartTrainingJobRequest` | 自动触发     | 触发“群体知识”的泛化训练    |

### 🧬 核心API草案 (`fleet.proto`)

```protobuf
// protos/arf/cloud/v1/fleet.proto
syntax = "proto3";

package arf.cloud.v1;

import "arf/v1/common.proto";

// 舰队管理服务
service FleetManagementService {
  // 向指定设备或设备组部署一个插件
  rpc DeployPlugin(DeployPluginRequest) returns (DeployPluginResponse);
  // 获取一个设备的实时状态
  rpc GetDeviceStatus(GetDeviceStatusRequest) returns (DeviceStatus);
  // 列出所有设备或按标签筛选
  rpc ListDevices(ListDevicesRequest) returns (ListDevicesResponse);
  // 向指定设备发送一个远程指令
  rpc SendCommandToDevice(SendCommandRequest) returns (SendCommandResponse);
  
  // [V1.1 新增] 启动一个A/B测试实验
  rpc StartExperiment(StartExperimentRequest) returns (StartExperimentResponse);
  // [V1.1 新增] 获取一个实验的状态和结果
  rpc GetExperimentStatus(GetExperimentStatusRequest) returns (ExperimentStatus);
}

message DeployPluginRequest {
  repeated string device_ids = 1;
  arf.v1.PluginIdentifier plugin = 2;
}
message DeployPluginResponse {
  string deployment_id = 1;
}

// A/B测试实验的定义
message ExperimentGroup {
    string name = 1;
    repeated string device_ids = 2; // 该组包含的设备
    arf.v1.PluginIdentifier plugin = 3; // 该组部署的插件版本
}

message StartExperimentRequest {
    string display_name = 1;
    ExperimentGroup control_group = 2; // 对照组
    ExperimentGroup experiment_group = 3; // 实验组
    repeated string kpi_metrics = 4; // e.g., "task_success_rate"
    string duration = 5; // e.g., "7d"
}


message GetDeviceStatusRequest {
  string device_id = 1;
}
message DeviceStatus {
  string device_id = 1;
  string status = 2; // e.g., "ONLINE", "OFFLINE"
  double battery_level = 3;
  // ... 其他遥测数据
}

// ... 其他请求和响应消息定义 ...
```

------



## 🛠️ 5. 技术栈与开发环境





### 💻 核心技术栈



| **技术领域**     | **选型**                              | **版本要求** | **用途说明**            |
| ---------------- | ------------------------------------- | ------------ | ----------------------- |
| **核心服务语言** | **Go**                                | `1.21+`      | 云原生后端的最佳选择    |
| **边缘计算框架** | **KubeEdge / OpenYurt**               | 最新稳定版   | 提供云-边协同的核心能力 |
| **数据库**       | **etcd / PostgreSQL**                 | 最新稳定版   | 存储设备期望状态        |
| **监控与告警**   | **Prometheus, Grafana, Alertmanager** | 最新稳定版   | 实现强大的可观测性      |
| **前端框架**     | **React / Vue.js**                    | 最新稳定版   | 构建舰队管理Web仪表盘   |

------



## 🔧 6. 开发实施细节





### 🏗️ 6.1 项目结构 V1



```
services/cloud-plane/fleet-manager/  # 云端控制器 (Go)
├── internal/
│   ├── controller/              # 核心控制循环逻辑
│   ├── store/                   # 数据库交互
│   └── server/                  # gRPC/REST服务器实现
└── ...

agents/edge-agent/                   # 边缘代理
├── Dockerfile                   # 用于打包边缘代理本身
└── ...
```



### 🧪 6.2 测试与验证策略



- **单元测试:** 对云端控制器的核心调度逻辑进行单元测试。
- **集成测试:**
  - **云-边连接测试:** 启动一个边缘代理，验证它能否成功注册到云端控制器并持续发送心跳。
  - **OTA更新测试:** 编写测试，通过API触发一次插件部署，验证边缘代理能否接收到指令，并成功拉取和启动对应的容器。
  - **断网恢复测试:** 在集成测试中，手动断开边缘代理与云端的网络连接5分钟，然后恢复。验证代理能否在网络恢复后自动重新连接，并同步到最新的期望状态。

------



## 🚀 7. 开发任务 (Getting Started)





#### **第一阶段：基础连接与手动部署 (Basic Connectivity & Manual Deployment)**



- **任务1：搭建云-边通信框架**
  - **交付物:** 在云端和边缘端分别部署KubeEdge或类似框架的核心组件，并验证两者之间可以建立安全的通信隧道。
- **任务2：开发云端控制器原型**
  - **交付物:** 一个Go服务，能处理边缘节点的注册请求，并将设备信息存入数据库。
- **任务3：手动部署边缘应用**
  - **交付物:** 提供一份教程，指导开发者如何通过编写Kubernetes CRD的方式，手动将一个简单的ACR容器部署到已注册的边缘节点上。



#### **第二阶段：API驱动的部署 (API-Driven Deployment)**



- **任务1：实现`DeployPlugin` API**
  - **交付物:** `FleetManagementService`的`DeployPlugin` gRPC方法能接收请求，从`插件市场`获取插件信息，并动态生成和应用所需的Kubernetes CRD。
- **任务2：实现`arf-cli`集成**
  - **交付物:** 开发者可以通过`arf-cli fleet deploy <device_id> <plugin_id>`命令来完成部署。
- **任务3：开发Web UI原型**
  - **交付物:** 一个简单的React/Vue前端页面，能列出所有已注册的设备，并提供一个表单来触发部署。



#### **第三阶段：监控与可观测性 (Monitoring & Observability)**



- **任务1：实现状态上报与监控**
  - **交付物:** 边缘代理能定期上报设备状态，云端控制器能接收这些状态并存入时序数据库（Prometheus）。
- **任务2：开发监控仪表盘**
  - **交付物:** 在Grafana中创建一个仪表盘，可视化展示舰队的在线状态、地理分布和关键健康指标。
- **任务3：实现远程日志查看**
  - **交付物:** 实现`arf-cli fleet logs <device_id>`命令，能够流式查看指定机器人的日志。



#### **第四阶段：高级功能与规模化 (Advanced Features & Scalability)**



- **任务1：实现分组与配置管理**
  - **交付物:** API和UI支持按标签对设备进行分组，并能对整个分组进行配置下发。
- **任务2：实现灰度发布与回滚**
  - **交付物:** `DeployPlugin` API支持更复杂的部署策略，如金丝雀发布（先部署到10%的设备）。提供一键回滚到上一版本的功能。
- **任务3：大规模压力测试**
  - **交付物:** 提交一份测试报告，展示舰队管理系统在模拟管理10,000台设备时的性能表现和资源消耗。



#### **第五阶段及以后：迈向群体智能 (Towards Collective Intelligence)**



*此部分为V1.1及后续版本规划，旨在构建数据驱动的智能闭环。*

- **任务5.1: 实现A/B测试API与执行器**
  - **交付物:** `FleetManagementService`完整实现`StartExperiment`接口。能够根据请求，为不同设备组下发不同版本的`DeployPlugin`指令。
- **任务5.2: 开发实验分析与报告后端**
  - **交付物:** `实验与分析引擎`能够定期从`数据中心`拉取实验相关的KPI数据，进行统计分析，并通过`GetExperimentStatus`接口返回分析结果。
- **任务5.3: 实现群体知识共享工作流原型**
  - **交付物:** 建立一个自动化的工作流：当一个特定格式的“经验”数据包出现在`数据中心`时，能自动触发`训练模块`运行一个泛化脚本，并将结果输出到`插件市场`。
- **任务5.4: 开发A/B测试Web UI**
  - **交付物:** 在Web前端，用户可以通过图形化界面来创建、启动、监控和分析A/B测试实验，并查看最终的报告和决策建议。
- **任务5.5: 升级监控仪表盘**
  - **交付物:** Web UI能够订阅并展示来自`HAL`的预测性维护告警和来自`Data Hub`的数据质量告警。
- **任务5.6: 实现能力感知部署**
  - **交付物:** `云端控制器`在执行部署前，会检查插件所需的能力（如`PREEMPT_RT`内核）与目标设备的画像是否匹配，不匹配则部署失败并告警。
- **任务5.7: 实现边缘智能策略配置**
  - **交付物:** `云端控制器`支持通过API和UI，为指定设备组下发`ACR`自适应调度策略和`DMS`智能同步策略的配置文件。
