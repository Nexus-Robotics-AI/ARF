# 🔥 ARF 模块开发参考文档：应用层 (Application)

> 🎯 **角色定位:** ARF的"产品"与"门面" - 将技术能力封装为面向场景的解决方案。
>
> 📦 **模块代号:** `arf-edge-app`
>
> ⚡ **所属:** ARF 边缘平台 (Edge Plane)

## 📋 1. 核心职责与设计理念

### 🎯 核心使命 (Core Mission)

作为ARF技术价值的“最终封装”，应用层的核心使命是**将底层的算法能力(`ACR`)和决策逻辑(`DIL`)，打包成面向特定垂直领域的、开箱即用的解决方案**。它负责处理端到端的业务逻辑，并为最终用户提供直观、易用的交互界面。

主要应用场景包括：

- **🏭 工业应用:** 视觉引导的抓取与放置、缺陷检测、自主移动物流。
- **🏡 家庭服务:** 老人陪护、智能家居控制、家庭清洁、智能陪聊。
- **🔬 科研应用:** 快速验证新的VLA、强化学习、人机交互算法的实验平台。
- **🏥 医疗应用:** 辅助手术、康复训练、智能诊断。

### 🏗️ 核心架构：应用套件 + UI分离 (App Suite + Decoupled UI)

应用层的设计将“后端业务逻辑”与“前端用户界面”分离。

- **应用套件 (Application Suite):** 这是一个**后端的、无界面的服务**。它的核心是一个**高度定制化的`DIL`服务**，内部编排了一组为特定场景精选的`ACR`算法容器。例如，“工业抓取套件”会加载高精度的检测算法，而“家庭陪聊套件”则会加载语音识别和生成算法。
- **用户界面 (User Interface):** 这是一个**独立的前端应用**（Web/移动端）。它通过`API`层提供的gRPC或RESTful接口与后端的“应用套件”进行通信，负责向用户展示信息和接收用户指令。

### ⚖️ 设计原则 (Design Principles)

- **🎯 场景驱动 (Scenario-Driven):** 应用层的一切设计都必须围绕最终用户的具体场景和需求展开。
- **📦 开箱即用 (Out-of-the-Box):** 应用套件应提供预配置好的默认参数和行为，让用户可以最小化配置就立即开始使用。
- **🔧 高度可配置 (Highly Configurable):** 为专业用户提供丰富的配置选项，允许他们根据自己的具体需求，调整应用的行为。
- **🎨 用户友好:** 前端UI的设计必须极其简洁、直观、易于上手，即使是非技术用户也能轻松操作。

## 📝 2. 核心需求 (Core Requirements)



| **ID** | **需求描述**                             | **验收标准**                                                 | **优先级** |
| ------ | ---------------------------------------- | ------------------------------------------------------------ | ---------- |
| **P1** | **场景化解决方案 (Scenario Solution)**   | 必须提供至少一个完整的、端到端的应用套件（如“家庭服务应用”），能够完成一个有意义的任务。 | **最高**   |
| **P2** | **用户交互界面 (User Interface)**        | 必须提供一个Web或移动端UI，让用户可以与应用套件进行交互（如下达指令、查看状态）。 | **最高**   |
| **P3** | **任务管理 (Task Management)**           | 应用层必须能管理任务的完整生命周期，包括任务的提交、监控、取消和结果查询。 | **高**     |
| **P4** | **应用配置与持久化 (App Configuration)** | 必须提供一种机制，允许用户自定义应用的参数（如机器人名字、工作区域），并将这些配置持久化存储。 | **高**     |
| **P5** | **多应用支持 (Multi-App Support)**       | (未来规划) ARF平台应支持同时安装和运行多个不同的应用套件，并允许用户在它们之间切换。 | **中**     |

## ⚙️ 3. 关键功能与子模块架构

### 🧠 3.1 应用套件 (Application Suite)

**后端大脑**：每一个应用套件，本质上都是一个**“特化”的`DIL`服务**。

- **场景化决策流:** 应用套件内部会包含一个为特定场景（如家庭环境）高度优化的行为树或状态机。
- **精选算法集:** 套件的配置文件会明确指定它依赖哪些`ACR`算法容器。在启动时，它会请求`ACR运行时`加载这些特定的算法。
- **业务逻辑封装:** 封装了该场景下的所有业务逻辑，例如，在家庭服务应用中，“取水”任务如何被分解和执行。

### 💻 3.2 用户界面 (User Interface - UI)

**交互窗口**：一个独立的前端项目。

- **状态可视化:** 通过订阅`DMS`或轮询`API`层，实时显示机器人的位置、状态、摄像头画面等。
- **任务控制:** 提供按钮、输入框等UI元素，让用户可以下达指令（如“去厨房”、“找到我的手机”）。
- **配置管理:** 提供一个设置页面，允许用户修改应用的参数。

### 📡 3.3 API层 (API Layer)

**前后端桥梁**：这是位于`应用套件`和`UI`之间的一个**可选但推荐**的中间层。

- **协议转换:** 将内部的gRPC接口转换为对Web前端更友好的RESTful API或WebSocket。
- **认证与授权:** 负责用户认证和权限管理。
- **请求聚合:** 可以将前端的多次请求聚合为对后端的一次调用，减少通信开销。

## 🔗 4. 接口设计与数据流

应用层是ARF信息流的顶端。

### 📥 输入数据流

| **数据源**      | **数据类型**                   | **优先级** | **延迟要求** | **示例场景**                  |
| --------------- | ------------------------------ | ---------- | ------------ | ----------------------------- |
| **最终用户**    | `TaskRequest` (HTTP/WebSocket) | `NORMAL`   | `< 1s`       | 用户在手机App上点击“开始清扫” |
| **DIL决策层**   | `TaskStatus` (gRPC)            | `NORMAL`   | `< 1s`       | 应用套件向UI报告任务进度      |
| **DMS数据总线** | `BusMessage` (各类状态)        | `LOW`      | `< 2s`       | UI订阅机器人电量信息          |

### 📤 输出数据流

| **目标模块**  | **数据类型**               | **保证** | **性能指标**           |
| ------------- | -------------------------- | -------- | ---------------------- |
| **DIL决策层** | `SubmitTaskRequest` (gRPC) | 可靠调用 | 任务提交成功率 > 99.9% |
| **最终用户**  | UI界面更新 (JSON/HTML)     | 实时响应 | 界面刷新延迟 < 500ms   |

### 🧬 核心API草案 (`api_gateway.proto`)

```
// protos/arf/edge/v1/api_gateway.proto
// 这个API服务由API层提供，作为UI和应用套件之间的网关
syntax = "proto3";

package arf.edge.v1;

import "arf/edge/v1/dil.proto"; // 导入DIL的任务定义

// API网关服务
service ApiGatewayService {
  // 提交一个新任务
  rpc StartTask(dil.SubmitTaskRequest) returns (dil.SubmitTaskResponse);
  // 获取任务状态
  rpc GetTaskStatus(dil.GetTaskStatusRequest) returns (dil.TaskStatus);
  // 订阅机器人实时状态的流
  rpc StreamRobotState(StreamRobotStateRequest) returns (stream RobotState);
}

message StreamRobotStateRequest {}

message RobotState {
    double battery_level = 1;
    // ... 其他需要UI展示的状态
}
```

## 🛠️ 5. 技术栈与开发环境

### 💻 核心技术栈

| **技术领域**     | **选型**                       | **版本要求** | **用途说明**              |
| ---------------- | ------------------------------ | ------------ | ------------------------- |
| **应用套件语言** | **Python**                     | `3.10+`      | 与DIL和ACR无缝集成        |
| **API层语言**    | **Go / Python**                | `Go 1.21+`   | 构建高性能的Web后端       |
| **Web后端框架**  | **FastAPI (Python), Gin (Go)** | 最新稳定版   | 提供RESTful/WebSocket接口 |
| **Web前端框架**  | **React / Vue.js**             | 最新稳定版   | 构建现代化的单页应用(SPA) |
| **移动端框架**   | **Flutter / React Native**     | 最新稳定版   | (可选)构建跨平台的移动App |

## 🔧 6. 开发实施细节

### 🏗️ 6.1 项目结构 V1

```
application/
└── home-assistant-app/            # 一个完整的应用套件项目
    ├── backend/                   # 后端应用套件 (特化的DIL)
    │   ├── main.py
    │   ├── logic/
    │   └── Dockerfile
    ├── frontend/                  # 前端UI项目 (React)
    │   ├── src/
    │   ├── public/
    │   └── Dockerfile
    └── deployments/
        └── docker-compose.yml     # 一键启动该应用的前后端
```

### 🧪 6.2 测试与验证策略



- **后端单元测试:** 对应用套件中的业务逻辑进行单元测试。
- **端到端测试 (E2E):** 使用Cypress或Playwright等工具，编写自动化测试脚本，模拟用户在前端UI上的完整操作（如登录->下达指令->查看结果），验证整个应用流程的正确性。
- **用户体验测试 (UAT):** 邀请真实用户试用产品，并收集反馈，以改进UI设计和交互流程。

------



## 🚀 7. 开发任务 (Getting Started)





#### **第一阶段：核心业务逻辑与无头(Headless)交互**



- **任务1：开发第一个应用套件后端**
  - **交付物:** 一个`home-assistant-backend`服务。它是一个特化的`DIL`，能够接收gRPC请求，并完成一个核心任务（例如，导航到指定房间）。
- **任务2：开发`arf-cli`的应用层交互命令**
  - **交付物:** 实现`arf app start-task "go to kitchen"`和`arf app get-status <task_id>`等CLI命令，作为第一个“无头”UI，用于测试和验证后端应用套件。



#### **第二阶段：Web前端与API网关**



- **任务1：开发API网关**
  - **交付物:** 一个API Gateway服务，将后端的gRPC接口转换为RESTful API。
- **任务2：开发Web前端UI v0.1**
  - **交付物:** 一个简单的React或Vue前端应用，至少包含一个输入框用于发送指令，一个区域用于显示机器人状态和任务反馈。
- **任务3：前后端联调**
  - **交付物:** 用户可以在Web界面输入“go to kitchen”，并能看到任务状态从“RUNNING”变为“SUCCEEDED”。



#### **第三阶段：丰富功能与用户体验优化**



- **任务1：实现实时状态更新**
  - **交付物:** UI通过WebSocket从API网关订阅机器人状态，实现电量、位置等信息的实时刷新。
- **任务2：开发应用配置界面**
  - **交付物:** 用户可以在UI上配置机器人的名字、家庭地图等信息，并能持久化保存。
- **任务3：用户体验测试与迭代**
  - **交付物:** 根据第一批用户的反馈，优化UI布局和交互流程。



#### **第四阶段：移动端与多应用支持**



- **任务1：开发移动App v0.1**
  - **交付物:** (可选)一个Flutter或React Native App，提供与Web端对等的核心功能。
- **任务2：实现“技能商店”原型**
  - **交付物:** UI中出现一个“技能商店”页面，可以从`插件市场`拉取并展示可安装的应用套 more
- **任务3：实现多应用切换**
  - **交付物:** 用户可以在不同的已安装应用套件之间进行切换。

