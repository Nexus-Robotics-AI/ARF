# 🔥 ARF 模块开发参考文档：开发者生态 (Dev)  V1.1

> 🎯 **角色定位:** ARF的"大门"与"工具箱" - 赋能所有开发者。
>
> 📦 **模块代号:** `arf-dev-tools`
>
> ⚡ **所属:** ARF 边缘平台 (Edge Plane)

## 📋 1. 核心职责与设计理念

### 🎯 核心使命 (Core Mission)

作为ARF生态的“大门”和“集成开发与调试环境(IDDE)”，Dev模块的核心使命是**为所有开发者提供一流的、无摩擦的开发、调试和测试体验**。它的进化目标是超越基础的命令行工具和SDK，提供一个**云边一体化的、可视化的、具备“时间旅行”调试能力的**综合开发平台，将机器人开发的效率提升到新的高度。

主要应用场景包括：

- **🚀 项目快速启动:** 开发者可以通过一个命令，快速创建符合ARF规范的标准项目模板。
- **💻 本地开发与调试:** 提供工具链，让开发者可以在本地轻松运行、测试和调试他们的模块。
- **☁️ 一键式云开发:** 开发者无需配置本地环境，一键在云端启动一个预设好的、连接到仿真和数据中心的VS Code开发环境。
- **📊 可视化调试与内省:** 提供一套Web可视化工具，让开发者能实时“看透”机器人内部的数据流、决策逻辑和坐标系状态。
- **⏪ “时间旅行”调试:** 对一次在真实机器人上失败的任务进行“录制”，然后在开发环境中**确定性地、反复地回放**失败瞬间，进行精准调试。
- **📦 统一的SDK:** 提供简洁、易用的多语言SDK，封装底层gRPC通信的复杂性。
- **📖 知识传递:** 通过文档中心，为开发者提供所有必要的教程、API参考和最佳实践。

### 🏗️ 核心架构：CLI为入口 + SDK为核心 + 可视化为洞察 (CLI-Gateway + SDK-Core + Visualization-Insight)

Dev模块的架构以两个核心产出物为中心：

- **`arf-cli` (命令行工具):** 这是开发者与ARF生态系统交互的**统一入口 (Unified Gateway)**。无论是管理本地容器、查询云端状态还是发布插件，所有操作都应通过`arf-cli`完成。它是一个“瑞士军刀”，为开发者提供一切所需。
- **多语言SDK (软件开发包):** 这是算法开发者编写逻辑的**核心依赖 (Core Dependency)**。
- **可视化调试套件 (Visualization Suite):** 这是V1.1架构的核心扩展。它是一组独立的、通过`arf-cli`启动的Web应用，通过订阅`DMS`或调用各模块的调试接口，来实时地、图形化地展示系统内部状态。

### ⚖️ 设计原则 (Design Principles)

- **🔧 体验至上 (DX First):** 所有工具和SDK的设计，都必须将开发者体验（Developer Experience）放在第一位。命令要直观，API要简洁，错误提示要清晰。
- **🔌 一致性:** CLI的命令风格、SDK的API设计模式，在整个生态系统中必须保持高度一致。
- **🤖 自动化:** 尽可能将重复性的工作（如项目创建、代码生成、环境配置）自动化，解放开发者的生产力。
- **👁️ 可观测性 (Observability):** “所见即所得”，让开发者能够轻松、直观地观测到系统内部的任何状态，是高效调试的前提。
- **📖 文档即代码:** 文档是Dev模块最重要的产出物之一，必须与代码同步更新，保持准确和清晰。

## 📝 2. 核心需求 (Core Requirements)

| **ID** | **需求描述**                             | **验收标准**                                                 | **优先级**       |
| ------ | ---------------------------------------- | ------------------------------------------------------------ | ---------------- |
| **V1** | **项目生命周期管理 (Project Lifecycle)** | `arf-cli`必须提供`init`, `build`, `test`, `run`等命令，覆盖从项目创建到运行的全过程。 | **最高**         |
| **V2** | **平台服务交互 (Platform Interaction)**  | `arf-cli`必须能作为客户端，与`ACR`, `DMS`, `Fleet Management`等核心服务进行gRPC通信，执行管理任务。 | **高**           |
| **V3** | **Python SDK核心功能**                   | Python SDK必须提供简洁的`Node`, `Publisher`, `Subscriber`抽象，封装与`DMS`的通信细节。 | **最高**         |
| **V4** | **多语言SDK支持 (Multi-lang SDK)**       | (未来规划) 架构应支持扩展到其他语言的SDK，如C++和Rust。      | **中**           |
| **V5** | **文档中心 (Doc Center)**                | 必须建立一个集中的、基于Web的文档中心，提供教程、API参考和贡献指南。 | **高**           |
| **V6** | **可视化调试工具**                       | **[V1.1+ 新增]** 必须提供至少三种Web可视化调试工具（如Topic查看、行为树可视化、坐标系可视化）。 | **最高 (V1.1+)** |
| **V7** | **一键式云开发环境**                     | **[V1.1+ 新增]** `arf-cli`必须支持命令，用于在云端自动创建和连接到一个预配置的、基于容器的开发环境。 | **高 (V1.1+)**   |
| **V8** | **时间旅行调试**                         | **[V1.1+ 新增]** `arf-cli`必须支持加载一个`DMS`记录文件，并将其内容回放到一个本地或云开发环境中，以复现问题。 | **高 (V1.1+)**   |

## ⚙️ 3. 关键功能与子模块架构

### CLI 3.1 `arf-cli` (命令行工具)



**瑞士军刀**：一个用`Go`实现的、跨平台的单个二进制文件。

- **命令解析器 (Command Parser):** 基于`Cobra`库构建，实现丰富的子命令和参数解析。
  - `arf container [start|stop|ls|logs]` - 管理ACR容器。
  - `arf data [record|info]` - 控制DMS数据记录。
  - `arf market [publish|search]` - 与云端插件市场交互。
  - `arf dev setup` - 初始化本地开发环境。
  - `arf dev debug [topic|bt|tf]` - **[V1.1+ 新增]** 启动相应的Web可视化调试工具。
  - `arf dev cloud [start|stop|connect]` - **[V1.1+ 新增]** 管理云开发环境。
  - `arf dev replay <dms_file>` - **[V1.1+ 新增]** 启动“时间旅行”调试会话。
  - `arf eval [start|status|report]` - **[V1.1+ 新增]** 管理Evaluation评测任务。
- **gRPC客户端管理器 (gRPC Client Manager):** 内部维护一个gRPC客户端池，用于连接到`ACR运行时`、`DMS服务`等后端。
- **项目模板引擎 (Template Engine):** `arf init`命令会内置一系列标准项目模板（如`acr-python-template`, `hal-rust-template`），用于快速创建新项目。

### 🐍 3.2 多语言SDK (Python, C++, etc.)

**翻译官**：为开发者提供优雅的接口，封装底层通信的复杂性。

- **客户端封装:** SDK内部会封装好与`DMS`, `HAL`等核心服务通信的gRPC客户端，并处理好连接、重试等细节，对开发者透明。
- **核心基类 (`Node`, `Publisher`, `Subscriber`):** 这是SDK的核心抽象，让开发者可以用类似ROS的模式进行开发。
- **初始化与日志 (`arf_sdk.init()`, `arf_sdk.get_logger()`):** 提供全局的初始化和日志获取功能，简化开发者的入口代码。

### 📊 3.3 可视化调试套件 (Visualization Suite)



**洞察之眼**：一组轻量级的Web服务和前端应用。

- **Topic Viewer:** 一个订阅`DMS`任意主题并实时将其内容以JSON或图表形式展示的Web应用。
- **Behavior Tree Viewer:** 一个订阅`DIL`状态主题，并以图形化方式实时渲染行为树执行状态的应用。
- **TF Viewer:** 一个订阅机器人坐标系广播，并在3D视图中实时展示各坐标系关系的应用。
- **实时性能分析器 (Real-time Performance Profiler):** **[V1.1+ 新增]** 一个专门的Web可视化工具，用于订阅`RTS`的性能遥测主题。它能够以实时图表（如抖动分布直方图、延迟时序图）的形式，清晰地展示硬实时任务的性能表现，帮助开发者快速定位性能瓶颈和异常。



### ☁️ 3.4 云开发环境管理器 (Cloud Dev Environment Manager)



**环境配置大师**：一个云端服务，负责实现`arf dev cloud`命令的后端逻辑。

- **职责:**
  1. 接收来自`arf-cli`的请求。
  2. 调用云平台API（如Kubernetes），动态地创建一个预配置的开发容器（包含VS Code Server、ARF SDK、项目代码）。
  3. 为该容器提供安全的网络接入，并将其连接信息返回给`arf-cli`。

## 🔗 4. 接口设计与数据流

Dev模块是系统中多个gRPC服务的“**主要客户**”。

### 📥 输入数据流

| **数据源**      | **数据类型**          | **优先级** | **延迟要求** | **示例场景**                       |
| --------------- | --------------------- | ---------- | ------------ | ---------------------------------- |
| **人类开发者**  | 命令行输入            | `CRITICAL` | `< 1s`       | 开发者在终端执行`arf container ls` |
| **ACR运行时**   | `LogEntry` (gRPC流)   | `NORMAL`   | `< 1s`       | `arf-cli`实时显示算法容器的日志    |
| **DMS数据总线** | `BusMessage` (gRPC流) | `NORMAL`   | `< 50ms`     | Python SDK的`Subscriber`接收数据   |

### 📤 输出数据流

| **目标模块**    | **数据类型**                   | **保证** | **性能指标**            |
| --------------- | ------------------------------ | -------- | ----------------------- |
| **ACR运行时**   | `StartContainerRequest` (gRPC) | 可靠调用 | CLI命令响应时间 < 500ms |
| **DMS数据总线** | `BusMessage` (gRPC)            | 可靠调用 | SDK发布消息延迟 < 10ms  |
| **标准输出**    | 格式化的文本/表格              | 用户友好 | 清晰、易读的命令行输出  |

## 🛠️ 5. 技术栈与开发环境

### 💻 核心技术栈

| **技术领域**    | **选型**                               | **版本要求** | **用途说明**                           |
| --------------- | -------------------------------------- | ------------ | -------------------------------------- |
| **CLI编程语言** | **Go**                                 | `1.21+`      | 跨平台、无依赖的单个二进制文件         |
| **SDK编程语言** | **Python**                             | `3.10+`      | AI生态的核心，快速迭代                 |
| **CLI框架**     | **Cobra, Viper (Go)**                  | 最新稳定版   | 构建强大、可配置的命令行应用           |
| **SDK打包**     | **Poetry / Hatch**                     | 最新稳定版   | 现代化的Python包管理和发布             |
| **文档生成**    | **Docusaurus / MkDocs**                | 最新稳定版   | 从Markdown生成静态文档网站             |
| **可视化后端**  | **Python (FastAPI) / Go**              | -            | 提供WebSocket将`DMS`数据流式传输到前端 |
| **可视化前端**  | **React / Vue.js**                     | 最新稳定版   | 构建现代化的、响应式的Web调试界面      |
| **云开发环境**  | **Docker, Kubernetes, VS Code Server** | -            | 提供标准化的、可远程访问的开发环境     |

## 🔧 6. 开发实施细节

### 🏗️ 6.1 项目结构 V1

```
tools/
└── arf-cli/                  # arf-cli (Go)
    ├── cmd/                  # Cobra命令定义
    │   ├── root.go
    │   ├── container.go      # 'container'子命令族
    │   └── data.go           # 'data'子命令族
    ├── internal/
    │   ├── clients/          # 调用ARF后台服务的gRPC客户端
    │   └── templates/        # 'init'命令使用的项目模板
    └── go.mod

sdk/
└── python/                   # python-sdk
    ├── arf_sdk/
    │   ├── __init__.py
    │   ├── node.py
    │   └── clients/
    ├── examples/
    │   └── talker_listener.py
    └── pyproject.toml
```

### 🧪 6.2 测试与验证策略



- **单元测试:** 对CLI的命令解析逻辑、SDK的核心类进行单元测试。
- **集成测试:**
  - **CLI-Service测试:** 编写集成测试，启动一个`mock`的gRPC服务，然后用`arf-cli`去调用它，验证端到端的命令执行是否正确。
  - **SDK-DMS测试:** 编写集成测试，启动一个真实的`DMS`服务，然后用Python SDK进行发布和订阅，验证数据收发的正确性。

------



## 🚀 7. 开发任务 (Getting Started)





#### **第一阶段：核心工具链骨架 (Core Toolchain Skeleton)**



- **任务1：实现`arf-cli`骨架和`init`命令**
  - **交付物:** 一个用Go实现的`arf-cli`程序，`init`子命令可以生成一个包含`arf.yaml`, `main.py`, `requirements.txt`的标准算法项目模板。
- **任务2：实现Python SDK骨架**
  - **交付物:** 一个`arf_sdk` Python包，包含空的`Node`, `Publisher`, `Subscriber`类定义和清晰的Docstrings。
- **任务3：搭建文档中心框架**
  - **交付物:** 一个基于Docusaurus/MkDocs的、可以本地运行的空文档网站。



#### **第二阶段：打通与核心服务的交互 (Interaction with Core Services)**



- **任务1：实现`arf-cli run`和日志查看**
  - **交付物:** `arf-cli run`命令能成功调用`ACR运行时`的gRPC服务。`arf-cli container logs`能流式打印日志。
- **任务2：实现SDK的Pub/Sub功能**
  - **交付物:** `Python SDK`的`Publisher`和`Subscriber`能通过gRPC成功连接到`DMS服务`并收发数据。
- **任务3：编写第一个“Hello, World”教程**
  - **交付物:** 一份Markdown教程，指导开发者如何使用`arf-cli`和`SDK`编写一个简单的“发布者-订阅者”应用。



#### **第三阶段：完善用户体验与生态功能 (DX & Ecosystem Features)**



- **任务1：完善CLI的用户体验**
  - **交付物:** 为所有CLI命令增加详细的帮助信息、参数自动补全、以及用户友好的错误提示。
- **任务-2：与插件市场集成**
  - **交付物:** 实现`arf market search/publish`等命令，打通与云端`Marketplace`的交互。
- **任务3：完成“30分钟上手”的“杀手级”教程**
  - **交付物:** 一份图文并茂的`Quickstart.md`文档，并邀请新用户进行测试，确保能在30分钟内完成。



#### **第四阶段：多语言支持与社区建设 (Multi-language & Community)**



- **任务1：设计并实现C++ SDK骨架**
  - **交付物:** 一个C++版本的SDK，提供与Python SDK对等的核心功能。
- **任务2：建立贡献者指南**
  - **交付物:** 一份`CONTRIBUTING.md`文档，清晰地说明社区开发者如何贡献代码、提交Issue和PR。
- **任务3：发布v1.0**
  - **交付物:** 将`arf-cli`的可执行文件和`Python SDK`的wheel包，通过CI/CD自动发布到GitHub Releases和PyPI。

#### **第五阶段及以后：迈向云边一体化IDDE (Towards Cloud-Edge IDDE)**



*此部分为V1.1及后续版本规划，旨在打造极致的开发效率和体验。*

- **任务5.1: 开发可视化调试套件**
  - **交付物:** 完整实现`arf dev debug topic`和`arf dev debug bt`命令。**新增**`arf dev debug rts-perf`命令，能够启动并展示`RTS`的实时性能图表。
- **任务5.2: 实现“时间旅行”调试器**
  - **交付物:** 实现`arf dev replay`命令。该命令能够启动一个本地的`DMS`服务实例，将指定的`.parquet`文件内容按原始速率发布出来，供本地运行的算法容器进行调试。
- **任务5.3: 实现一键式云开发环境**
  - **交付物:** 实现`arf dev cloud start`命令，能够在云端Kubernetes集群中成功创建一个包含VS Code Server和项目代码的Pod，并建立本地到该Pod的安全连接。
- **任务5.4: 集成评测模块**
  - **交付物:** 完整实现`arf-cli eval`命令族，允许开发者从命令行启动评测、查询状态并获取最终的评测报告链接。
- **任务5.5: 完善开发者文档与教程**
  - **交付物:** 撰写一系列新的“杀手级”教程，详细演示如何使用可视化工具和时间旅行调试器来解决一个复杂的、难以复现的Bug。